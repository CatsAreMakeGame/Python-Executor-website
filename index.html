<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonista Web Editor v1.2.4</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #212121;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #ddd;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        header {
            background-color: #1a1a1a;
            padding: 0 15px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #menu-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #menu-btn:hover { color: #fff; }

        h1 { font-size: 16px; margin: 0; color: #fff; font-weight: 500; }
        .version-tag { font-size: 10px; color: #4caf50; margin-left: 5px; vertical-align: middle; border: 1px solid #4caf50; padding: 1px 4px; border-radius: 3px; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #save-btn {
            background-color: #444;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #save-btn:hover { background-color: #555; }

        #run-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        #run-btn:hover { background-color: #218838; }

        /* EDITOR AREA */
        #editor-wrapper {
            flex: 1;
            position: relative;
            font-size: 16px;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%; 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.5;
        }

        /* CONSOLE AREA */
        #console-wrapper {
            height: 35%;
            background-color: #000;
            border-top: 2px solid #444;
            display: flex;
            flex-direction: column;
        }

        #console-header {
            background: #333;
            padding: 5px 10px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
            color: #999;
            display: flex;
            justify-content: space-between;
        }

        #output {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #fff;
        }

        /* AUTOCOMPLETE STYLING */
        .CodeMirror-hints {
            background: #252526 !important;
            border: 1px solid #454545 !important;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            padding: 4px 0 !important;
        }
        .CodeMirror-hint {
            color: #d4d4d4 !important;
            padding: 4px 10px !important;
            font-family: 'Menlo', monospace;
        }
        .CodeMirror-hint-active {
            background: #094771 !important; /* VS Code Blue */
            color: #fff !important;
        }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <div class="header-left">
            <button id="menu-btn" onclick="alert('Menu: Settings coming soon!')">â˜°</button>
            <div>
                <h1>Pythonista Runner <span class="version-tag">v1.2.4</span></h1>
            </div>
        </div>
        <div class="header-right">
            <button id="save-btn" onclick="saveScript()">ðŸ’¾ Save</button>
            <button id="run-btn" onclick="runPython()">Loading...</button>
        </div>
    </header>

    <div id="editor-wrapper">
<textarea id="code-editor">
# Pythonista Web Editor v1.2.4
# Feature Added: Input() support!

name = input("Enter your name: ")
print(f"Hello, {name}!")

age = input("Enter your age: ")
print(f"Wow, {age} is a great age.")
</textarea>
    </div>

    <div id="console-wrapper">
        <div id="console-header">
            <span>Console Output</span>
            <span style="cursor:pointer;" onclick="document.getElementById('output').innerHTML=''">Clear</span>
        </div>
        <div id="output"><span style="color:#888;">Initializing Python environment...</span></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
    // --- 1. DATA DEFINITIONS ---
    const PYTHON_KEYWORDS = [
        "import", "from", "def", "return", "if", "elif", "else", 
        "while", "for", "in", "try", "except", "class", "True", "False", 
        "None", "and", "or", "not", "break", "continue", "pass", "lambda",
        "len", "range", "list", "dict", "set", "int", "str", "float", "input"
    ];

    const PYTHON_METHODS = [
        "remove", "append", "extend", "insert", "pop", "clear", "index", 
        "count", "sort", "reverse", "copy", "split", "join", "strip", 
        "lower", "upper", "replace", "find", "format", "keys", "values", "items"
    ];

    // --- 2. EDITOR SETUP ---
    var editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        mode: {name: "python", version: 3, singleLineStringErrors: false},
        theme: "material-darker",
        lineNumbers: true,
        indentUnit: 4,
        autoCloseBrackets: true,
        extraKeys: {
            "Ctrl-Space": "autocomplete",
            
            // F-STRING QUOTE HANDLER
            "'": function(cm) { return handleQuote(cm, "'"); },
            '"': function(cm) { return handleQuote(cm, '"'); },
            
            // SMART DEDENT
            ":": function(cm) {
                cm.replaceSelection(":");
                var cur = cm.getCursor();
                var line = cm.getLine(cur.line);
                var trimmed = line.trim();

                if (trimmed === "else:" || trimmed === "elif:" || trimmed === "except:" || trimmed === "finally:") {
                    cm.indentLine(cur.line, "smart");
                }
            }
        }
    });

    function handleQuote(cm, quoteChar) {
        var cur = cm.getCursor();
        var line = cm.getLine(cur.line);
        var charBefore = line.charAt(cur.ch - 1);
        var charTwoBefore = (cur.ch >= 2) ? line.charAt(cur.ch - 2) : " ";
        var isWordCharBefore = /[a-zA-Z0-9_]/.test(charTwoBefore);

        if ((charBefore === "f" || charBefore === "F") && !isWordCharBefore) {
            cm.replaceSelection(quoteChar + quoteChar);
            cm.setCursor({line: cur.line, ch: cur.ch + 1});
        } else {
            return CodeMirror.Pass;
        }
    }

    // --- 3. AUTOCOMPLETE ENGINE ---
    editor.on("keyup", function (cm, event) {
        if (!cm.state.completionActive && 
            !event.ctrlKey && !event.altKey && !event.metaKey &&
            ((event.keyCode >= 65 && event.keyCode <= 90) || event.keyCode === 190)) { 
            
            CodeMirror.showHint(cm, function() {
                var cur = cm.getCursor();
                var token = cm.getTokenAt(cur);
                
                var currentWord = token.string;
                var start = token.start;
                var end = cur.ch;
                
                var isDotContext = false;
                if (currentWord === ".") {
                    isDotContext = true;
                    currentWord = ""; 
                    start = cur.ch; 
                } else if (token.type === "property") {
                    isDotContext = true;
                } else {
                    var charBefore = cm.getRange({line: cur.line, ch: start - 1}, {line: cur.line, ch: start});
                    if (charBefore === ".") isDotContext = true;
                }

                var list = [];

                if (isDotContext) {
                    list = PYTHON_METHODS.filter(function(item) {
                        return item.toLowerCase().startsWith(currentWord.toLowerCase());
                    });
                } else {
                    var text = cm.getValue();
                    var foundWords = text.match(/[a-zA-Z_][a-zA-Z0-9_]*/g) || [];
                    var allWords = PYTHON_KEYWORDS.concat(foundWords);
                    var uniqueWords = [...new Set(allWords)];

                    list = uniqueWords.filter(function(item) {
                        return item !== currentWord && item.toLowerCase().startsWith(currentWord.toLowerCase());
                    });

                    if ("print".startsWith(currentWord.toLowerCase())) {
                        list.unshift({
                            text: "print()", 
                            displayText: "print()  (Function)",
                            hint: function(cm, self, data) {
                                cm.replaceRange("print()", self.from, self.to);
                                var cursorPos = self.from;
                                cm.setCursor({line: cursorPos.line, ch: cursorPos.ch + 6});
                            }
                        });
                    }
                }

                return {
                    list: list,
                    from: CodeMirror.Pos(cur.line, start),
                    to: CodeMirror.Pos(cur.line, end)
                };
            }, {completeSingle: false}); 
        }
    });

    // --- 4. PYTHON ENGINE ---
    let pyodide = null;
    const outputDiv = document.getElementById("output");
    const runBtn = document.getElementById("run-btn");

    function log(text, isError = false) {
        const span = document.createElement('div');
        span.textContent = text;
        if (isError) span.style.color = "#ff6b6b";
        outputDiv.appendChild(span);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    async function initPython() {
        try {
            pyodide = await loadPyodide();
            pyodide.setStdout({ batched: (msg) => log(msg) });
            pyodide.setStderr({ batched: (msg) => log(msg, true) });
            
            runBtn.innerText = "â–¶ RUN";
            runBtn.disabled = false;
            log(">> Python Ready.");
        } catch (err) {
            log("Error loading Python: " + err, true);
        }
    }

    initPython();

    // CUSTOM INPUT HANDLER
    // Pyodide cannot pause execution natively in the main thread for input()
    // We override builtins.input to use the browser's JS prompt()
    const BOOTLOADER_CODE = `
import builtins
from js import prompt

def _input(p=""):
    val = prompt(p)
    if val is None:
        return ""
    print(f"{p}{val}") # Echo input to console for realism
    return str(val)

builtins.input = _input
`;

    async function runPython() {
        if (!pyodide) return;
        outputDiv.innerHTML = "";
        let code = editor.getValue();
        
        try {
            // Load the custom input function first
            await pyodide.runPythonAsync(BOOTLOADER_CODE);
            // Then run user code
            await pyodide.runPythonAsync(code);
        } catch (err) {
            log(err, true);
        }
    }

    // --- 5. SAVE FEATURE ---
    function saveScript() {
        const code = editor.getValue();
        const blob = new Blob([code], { type: "text/x-python" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "script.py";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
