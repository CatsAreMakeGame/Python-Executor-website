<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonista Web Editor</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #212121;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #ddd;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        header {
            background-color: #1a1a1a;
            padding: 0 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
            flex-shrink: 0;
        }

        h1 { font-size: 18px; margin: 0; color: #fff; }

        /* EDITOR AREA */
        #editor-wrapper {
            flex: 1;
            position: relative;
            font-size: 16px;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%; 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 15px;
        }

        /* CONSOLE AREA */
        #console-wrapper {
            height: 35%;
            background-color: #000;
            border-top: 2px solid #444;
            display: flex;
            flex-direction: column;
        }

        #console-header {
            background: #333;
            padding: 5px 10px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: bold;
            color: #ccc;
        }

        #output {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #fff;
        }

        /* BUTTONS */
        #run-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        #run-btn:hover { background-color: #218838; }

        /* AUTOCOMPLETE STYLING (Pythonista Style) */
        .CodeMirror-hints {
            background: #2e2e2e !important;
            border: 1px solid #444 !important;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            padding: 0 !important;
        }
        .CodeMirror-hint {
            color: #ccc !important;
            padding: 6px 10px !important;
            border-bottom: 1px solid #3a3a3a;
        }
        .CodeMirror-hint:last-child { border-bottom: none; }
        
        .CodeMirror-hint-active {
            background: #007acc !important; /* Blue highlight */
            color: #fff !important;
        }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <h1>Pythonista Runner</h1>
        <button id="run-btn" onclick="runPython()">Loading...</button>
    </header>

    <div id="editor-wrapper">
<textarea id="code-editor">
# Example: Variable Autocomplete
# 1. Run this code
# 2. Try typing 'my' on a new line!

myList = ['bob', 'gram', 'oaky']

print("List created.")
</textarea>
    </div>

    <div id="console-wrapper">
        <div id="console-header">Console Output</div>
        <div id="output"><span style="color:#888;">Initializing Python environment...</span></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
    // 1. BASE KEYWORDS
    const PYTHON_KEYWORDS = [
        "print", "import", "from", "def", "return", "if", "elif", "else", 
        "while", "for", "in", "try", "except", "class", "True", "False", 
        "None", "and", "or", "not", "break", "continue", "pass", "lambda",
        "len", "range", "list", "dict", "set", "int", "str", "float"
    ];

    // 2. SETUP EDITOR
    var editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        mode: {name: "python", version: 3, singleLineStringErrors: false},
        theme: "material-darker",
        lineNumbers: true,
        indentUnit: 4,
        autoCloseBrackets: true,
        extraKeys: {"Ctrl-Space": "autocomplete"}
    });

    // 3. INTELLIGENT AUTOCOMPLETE LOGIC
    editor.on("keyup", function (cm, event) {
        // Ignore navigation keys
        if (!cm.state.completionActive && 
            !event.ctrlKey && !event.altKey && !event.metaKey &&
            ((event.keyCode >= 65 && event.keyCode <= 90) || event.keyCode === 190)) { // Letters or dot
            
            CodeMirror.showHint(cm, function() {
                var cur = cm.getCursor();
                var token = cm.getTokenAt(cur);
                var currentWord = token.string;
                var start = token.start;
                var end = cur.ch;

                // Stop if typing special chars other than valid identifier parts
                if (!currentWord.match(/^[a-zA-Z0-9_]+$/)) return;

                // A. GET WORDS FROM DOCUMENT
                // This regex finds every word in the editor
                var text = cm.getValue();
                var foundWords = text.match(/[a-zA-Z_][a-zA-Z0-9_]*/g) || [];

                // B. MERGE WITH KEYWORDS
                var allWords = PYTHON_KEYWORDS.concat(foundWords);

                // C. REMOVE DUPLICATES (Set)
                var uniqueWords = [...new Set(allWords)];

                // D. FILTER MATCHES
                // We show words that start with what you typed
                var list = uniqueWords.filter(function(item) {
                    return item !== currentWord && item.toLowerCase().startsWith(currentWord.toLowerCase());
                });

                return {
                    list: list,
                    from: CodeMirror.Pos(cur.line, start),
                    to: CodeMirror.Pos(cur.line, end)
                };
            }, {completeSingle: false}); 
        }
    });

    // 4. SETUP PYODIDE (Python Engine)
    let pyodide = null;
    const outputDiv = document.getElementById("output");
    const runBtn = document.getElementById("run-btn");

    function log(text, isError = false) {
        const span = document.createElement('div');
        span.textContent = text;
        if (isError) span.style.color = "#ff6b6b";
        outputDiv.appendChild(span);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    async function initPython() {
        try {
            pyodide = await loadPyodide();
            pyodide.setStdout({ batched: (msg) => log(msg) });
            pyodide.setStderr({ batched: (msg) => log(msg, true) });
            
            runBtn.innerText = "â–¶ RUN";
            runBtn.disabled = false;
            log(">> Python Ready.");
        } catch (err) {
            log("Error loading Python: " + err, true);
        }
    }

    initPython();

    async function runPython() {
        if (!pyodide) return;
        outputDiv.innerHTML = "";
        let code = editor.getValue();
        try {
            await pyodide.runPythonAsync(code);
        } catch (err) {
            log(err, true);
        }
    }
</script>

</body>
</html>
