<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonista-Style Web Editor</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --editor-bg: #282c34;
            --text-color: #abb2bf;
            --accent-color: #98c379;
            --button-color: #61afef;
            --output-bg: #121212;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 1rem;
            background-color: #181818;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #fff; }

        /* The container for CodeMirror */
        #editor-container {
            flex-grow: 1;
            font-size: 16px;
            overflow: auto;
        }

        /* Adjusting CodeMirror height */
        .cm-editor {
            height: 100%;
        }

        #output-container {
            height: 30%;
            background-color: var(--output-bg);
            border-top: 2px solid #333;
            padding: 1rem;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
        }

        .output-line { margin: 2px 0; }
        .error-line { color: #e06c75; }
        .success-line { color: var(--text-color); }
        .system-msg { color: #5c6370; font-style: italic; }

        button#run-btn {
            background-color: var(--button-color);
            color: #fff;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button#run-btn:hover { background-color: #4da0e6; }
        button#run-btn:disabled { background-color: #4b5263; cursor: wait; }

        /* Customizing the Autocomplete Widget (The "Dark Prediction") */
        .cm-tooltip-autocomplete {
            background-color: #21252b !important;
            border: 1px solid #181a1f !important;
        }
        
        .cm-tooltip-autocomplete > ul > li {
            color: #abb2bf;
            padding: 4px 8px;
        }

        .cm-tooltip-autocomplete > ul > li[aria-selected] {
            background-color: #2c313a !important;
            color: #fff !important;
        }
        
        .cm-completionLabel { font-weight: bold; color: #e5c07b; }
        .cm-completionDetail { font-style: italic; color: #5c6370; margin-left: 0.5em;}
    </style>
</head>
<body>

<header>
    <h1>Pythonista Web Runner</h1>
    <button id="run-btn" onclick="runCode()">Loading Python...</button>
</header>

<div id="editor-container"></div>
<div id="output-container" id="output">
    <div class="system-msg">Initializing Python environment... please wait.</div>
</div>

<script type="module">
    import {EditorState, basicSetup} from "https://esm.sh/@codemirror/basic-setup";
    import {EditorView, keymap} from "https://esm.sh/@codemirror/view";
    import {python} from "https://esm.sh/@codemirror/lang-python";
    import {oneDark} from "https://esm.sh/@codemirror/theme-one-dark";
    import {autocompletion} from "https://esm.sh/@codemirror/autocomplete";

    // 1. SETUP CODEMIRROR EDITOR
    const state = EditorState.create({
        doc: "# Write your Python code here\n\nprint('Hello, Pythonista!')\n\n# Try typing 'pri' below to see the autocomplete:\n",
        extensions: [
            basicSetup,
            python(),
            oneDark,
            autocompletion({override: null}), // Enable autocomplete
            EditorView.lineWrapping
        ]
    });

    const view = new EditorView({
        state,
        parent: document.getElementById("editor-container")
    });

    // Make editor view global so we can access it in runCode
    window.editorView = view;
</script>

<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
    let pyodide = null;
    const outputDiv = document.getElementById("output-container");
    const runBtn = document.getElementById("run-btn");

    // 2. HELPER TO LOG TO HTML CONSOLE
    function log(text, type = 'success-line') {
        const div = document.createElement('div');
        div.className = type === 'error' ? 'output-line error-line' : 'output-line success-line';
        if(type === 'system') div.className = 'output-line system-msg';
        
        div.textContent = text;
        outputDiv.appendChild(div);
        outputDiv.scrollTop = outputDiv.scrollHeight; // Auto scroll
    }

    // 3. INITIALIZE PYTHON
    async function main() {
        try {
            pyodide = await loadPyodide();
            
            // Custom Python print handler to redirect stdout to our HTML div
            pyodide.setStdout({
                batched: (msg) => log(msg)
            });

            runBtn.innerText = "â–¶ Run";
            runBtn.disabled = false;
            log("Python Ready!", "system");
        } catch (err) {
            log("Error loading Python: " + err, "error");
        }
    }

    main();

    // 4. EXECUTE CODE
    async function runCode() {
        if (!pyodide) return;
        
        // Clear previous output (optional, strictly personal preference)
        outputDiv.innerHTML = ""; 
        log("--- Execution Start ---", "system");

        // Get code from CodeMirror
        const code = window.editorView.state.doc.toString();

        try {
            // Run the Python code
            await pyodide.runPythonAsync(code);
        } catch (err) {
            log(err, "error");
        }
    }
</script>

</body>
</html>
