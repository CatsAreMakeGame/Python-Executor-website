<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonista Web Editor</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #212121;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #ddd;
            overflow: hidden; /* Prevent body scroll, let containers scroll */
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        header {
            background-color: #1a1a1a;
            padding: 10px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
        }

        h1 { font-size: 18px; margin: 0; color: #fff; }

        /* EDITOR AREA */
        #editor-wrapper {
            flex: 1; /* Takes up remaining space */
            position: relative;
            font-size: 16px;
        }

        /* Force CodeMirror to fill the wrapper */
        .CodeMirror {
            height: 100%; 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        /* CONSOLE AREA */
        #console-wrapper {
            height: 35%;
            background-color: #000;
            border-top: 2px solid #444;
            display: flex;
            flex-direction: column;
        }

        #console-header {
            background: #333;
            padding: 5px 10px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: bold;
            color: #ccc;
        }

        #output {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #fff;
        }

        /* RUN BUTTON */
        #run-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        #run-btn:hover { background-color: #218838; }
        #run-btn:disabled { background-color: #555; cursor: wait; }

        /* AUTOCOMPLETE STYLING (Pythonista Style) */
        .CodeMirror-hints {
            background: #2e2e2e !important;
            border: 1px solid #444 !important;
            border-radius: 4px;
        }
        .CodeMirror-hint {
            color: #aaa !important;
            padding: 4px 8px !important;
            border-radius: 2px;
        }
        .CodeMirror-hint-active {
            background: #007acc !important; /* Blue highlight */
            color: #fff !important;
        }

        /* UTILS */
        .sys-msg { color: #888; font-style: italic; }
        .err-msg { color: #ff6b6b; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <h1>Pythonista Runner</h1>
        <button id="run-btn" onclick="runPython()">Loading...</button>
    </header>

    <div id="editor-wrapper">
        <textarea id="code-editor">
# Type 'pri' below to test autocomplete!

print("Hello World")

def my_function():
    return "Done"
</textarea>
    </div>

    <div id="console-wrapper">
        <div id="console-header">Console Output</div>
        <div id="output"><span class="sys-msg">Initializing Python environment...</span></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
    // 1. SETUP EDITOR
    // Define a list of Python keywords for our simple autocomplete
    const PYTHON_KEYWORDS = [
        "print", "import", "from", "def", "return", "if", "elif", "else", 
        "while", "for", "in", "try", "except", "class", "True", "False", 
        "None", "and", "or", "not", "break", "continue", "pass", "lambda"
    ];

    // Initialize CodeMirror
    var editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        mode: {name: "python", version: 3, singleLineStringErrors: false},
        theme: "material-darker",
        lineNumbers: true,
        indentUnit: 4,
        autoCloseBrackets: true, // Automatically closes () [] {}
        extraKeys: {"Ctrl-Space": "autocomplete"}
    });

    // 2. ENABLE AUTO-PREDICT (The "Pythonista" Logic)
    editor.on("keyup", function (cm, event) {
        // Don't trigger on navigation keys (arrows, enter, etc.)
        if (!cm.state.completionActive && /*Enables keyboard navigation in autocomplete list*/
            !event.ctrlKey && !event.altKey && !event.metaKey &&
            (event.keyCode >= 65 && event.keyCode <= 90) || // Letters
            (event.keyCode === 190) // Period (.)
           ) { 
            
            // Manual hint function to use our keyword list
            CodeMirror.showHint(cm, function() {
                var cur = cm.getCursor();
                var token = cm.getTokenAt(cur);
                var start = token.start;
                var end = cur.ch;
                var word = token.string;
                
                // If typing a dot, show nothing or specific properties (simplified here)
                if (word === ".") return null;

                var list = PYTHON_KEYWORDS.filter(function(item) {
                    return item.toLowerCase().startsWith(word.toLowerCase());
                });

                return {
                    list: list,
                    from: CodeMirror.Pos(cur.line, start),
                    to: CodeMirror.Pos(cur.line, end)
                };
            }, {completeSingle: false}); 
        }
    });

    // 3. SETUP PYODIDE (Python Engine)
    let pyodide = null;
    const outputDiv = document.getElementById("output");
    const runBtn = document.getElementById("run-btn");

    function log(text, isError = false) {
        const span = document.createElement('div');
        span.textContent = text;
        if (isError) span.style.color = "#ff6b6b";
        outputDiv.appendChild(span);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    async function initPython() {
        try {
            pyodide = await loadPyodide();
            // Redirect Python 'print' to our div
            pyodide.setStdout({ batched: (msg) => log(msg) });
            pyodide.setStderr({ batched: (msg) => log(msg, true) });
            
            runBtn.innerText = "â–¶ RUN";
            runBtn.disabled = false;
            log(">> Python Ready. Type code and press RUN.");
        } catch (err) {
            log("Error loading Python: " + err, true);
        }
    }

    initPython();

    // 4. RUN CODE FUNCTION
    async function runPython() {
        if (!pyodide) return;
        outputDiv.innerHTML = ""; // Clear console
        let code = editor.getValue();
        
        try {
            await pyodide.runPythonAsync(code);
        } catch (err) {
            log(err, true);
        }
    }
</script>

</body>
</html>
